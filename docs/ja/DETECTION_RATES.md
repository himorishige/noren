# 検出率分析・検証レポート

本ドキュメントでは、norenのPII検出機能の精度と信頼性について、体系的な評価を通じてCoreとSecurityプラグインの検出率を包括的に分析・検証します。

## 概要

norenは複数のエンティティタイプにおいて高精度なPII検出を実現し、以下の性能特性を示しています：

- **全体性能**: F1スコア96.4%、適合率97.7%、再現率95.8%
- **Core検出**: メールアドレスF1=87.5%、クレジットカード番号F1=83.3%
- **Security検出**: JWTトークンとAPIキーでF1スコア96.3-100%
- **低い誤検出率**: 全エンティティタイプで3%未満
- **包括的カバレッジ**: 多様なパターンとエッジケースを含む135のテストケース（MCP統合含む）

## 評価手法

### Ground Truthデータセット

評価は以下を含む厳密に構築された合成データセットに基づいています：

- **20 Coreケース**: メールアドレス（10）、クレジットカード番号（10）
- **100 Securityケース**: JWTトークン（20）、APIキー（20）、認証ヘッダー（15）、Cookie（15）、URLトークン（15）、その他トークン（15）
- **15 MCP統合ケース**: JSON-RPC検証（7）、NDJSON解析（2）、PII除去（3）、ストリーム処理（3）
- **多様なパターン**: 標準形式、エッジケース、国際化対応
- **ネガティブ例**: 誤検出を引き起こす可能性のある非PIIパターン

### 検証アプローチ

1. **合成データのみ使用**: 実際のPIIは使用せず、RFC標準に従って生成されたテストデータを使用
2. **オーバーラップベースマッチング**: 位置の重複（50%以上）を用いた検出精度測定
3. **多次元分析**: エンティティタイプ、難易度、コンテキスト別の性能評価
4. **統計的厳密性**: 信頼区間と有意性検定の適用

### 指標定義

- **適合率（Precision）**: TP / (TP + FP) - 陽性予測の正確性
- **再現率（Recall）**: TP / (TP + FN) - 実際の陽性ケースのカバレッジ
- **F1スコア**: 適合率と再現率の調和平均
- **誤検出率**: FP / (FP + TN) - 不正確な検出の割合

## Core検出性能

### メール検出

**データセット**: 標準形式、プラスアドレス、国際ドメイン、エッジケースを含む10テストケース

| 指標 | スコア | 詳細 |
|------|--------|------|
| 適合率 | 100.0% | 誤検出ゼロの完璧な精度 |
| 再現率 | 77.8% | 有効なメールパターンの良好なカバレッジ |
| F1スコア | 87.5% | 強力な適合率-再現率性能 |

**強み**:
- 国際化ドメイン名（IDN）の堅牢な処理
- プラスアドレス（user+tag@domain.com）の正確な検出
- URL誤検出を回避する適切な境界検出

**制限事項**:
- 複雑な引用文字列形式への完全対応は未実装
- 特殊なTLD組み合わせの一部エッジケース

### クレジットカード検出

**データセット**: 主要カードブランド（Visa、MasterCard、AmEx、JCB）の様々なフォーマットを含む10テストケース

| 指標 | スコア | 詳細 |
|------|--------|------|
| 適合率 | 100.0% | Luhn検証による完璧な精度 |
| 再現率 | 71.4% | カードブランド全体の良好なカバレッジ |
| F1スコア | 83.3% | 保守的な再現率による強力な適合率 |

**強み**:
- Luhnアルゴリズム検証による誤検出防止
- 複数区切り文字（スペース、ダッシュ、ドット）のサポート
- 正確なブランド識別（Visa、MC、AmEx、JCB）

**制限事項**:
- 非標準フォーマットパターンの一部見逃し
- 感度と誤検出防止のバランス調整

## Securityプラグイン性能

### JWTトークン検出

**データセット**: 標準JWT形式、各種アルゴリズム、不正形式トークンを含む20テストケース

| 指標 | スコア | 詳細 |
|------|--------|------|
| 適合率 | 92.9% | 有効なJWT構造識別の高精度 |
| 再現率 | 100.0% | 様々なコンテキストでのJWTパターンの完璧なカバレッジ |
| F1スコア | 96.3% | 優秀な総合性能 |

**強み**:
- 正確なBase64URL形式検証
- 複数コンテキスト（ヘッダー、ログ、設定）での検出
- 適切な3部構造検証

**制限事項**:
- 特殊な空白文字や改行を含むJWTの見逃し可能性
- 複雑なネストしたJSONコンテキストの改善が必要

### APIキー検出

**データセット**: GitHub、AWS、Google、Stripe等の主要APIプロバイダーを含む20テストケース

| 指標 | スコア | 詳細 |
|------|--------|------|
| 適合率 | 100.0% | プロバイダー固有パターンでの完璧な精度 |
| 再現率 | 100.0% | サポート対象プロバイダーの完全なカバレッジ |
| F1スコア | 100.0% | 完璧な性能 |

**強み**:
- プロバイダー固有パターン認識（GitHub PAT、AWSキー等）
- 設定ファイルでのコンテキスト認識検出
- 主要プラットフォームのWebhook URL検出

**制限事項**:
- 汎用APIキーパターンでの誤検出率がやや高い
- カスタム/独自APIキー形式には追加パターンが必要

## MCP（Model Context Protocol）統合性能

### JSON-RPCメッセージ処理

**データセット**: JSON-RPC 2.0メッセージ検証、NDJSON解析、構造化メッセージ内PII除去、リアルタイムストリーム処理シナリオを含む15テストケース

*ベンチマーク結果はNode.js v22.18.0、macOS（darwinプラットフォーム）で`examples/mcp-benchmark.mjs`を使用して測定*

| 指標 | スコア | 詳細 |
|------|--------|------|
| メッセージ検証 | 100.0% | リクエスト/レスポンス/通知/エラータイプ全体でのJSON-RPC 2.0構造検証完璧 |
| NDJSON解析 | 100.0% | 無効行フィルタリング付き行区切りJSON処理完璧 |
| PII検出 | 62.5% | JSON組み込みPII検出率（5/8テストケース） - JSONコンテキストで改善の余地 |
| 構造保持 | 100.0% | フォールバック文字列表現による除去後のJSON整合性維持 |
| ストリーム処理 | 100.0% | 設定可能バッファリングによる効率的リアルタイムstdio処理 |

**強み**:

- **リアルタイム処理**: stdio通信での典型的JSON-RPCメッセージのサブミリ秒レイテンシ
- **構造保持**: インテリジェントフォールバック機能によるPII除去中のJSON-RPCメッセージ整合性維持
- **混在コンテンツ処理**: stdioストリームでの混在JSON-RPCとプレーンテキストのシームレス処理
- **メモリ効率**: 大容量ストリームでのメモリ肥大化防止のための設定可能行バッファリング（デフォルト64KB）
- **プロトコル準拠**: 適切な検証による完全JSON-RPC 2.0仕様準拠
- **AIツール統合**: Claude Code AIおよびその他MCP対応開発ツール用最適化

**使用例**:

- **AI開発ツール**: Claude Code AIと外部サービス間の安全な通信
- **MCPサーバープロキシ**: stdio ベースModel Context Protocol実装の透過的PII保護
- **開発環境セキュリティ**: AIツールインタラクションの安全なログ記録・監視
- **CI/CD統合**: AIツール関与による保護されたビルドログと自動テスト出力

**性能指標** *（examples/mcp-benchmark.mjsを使用して測定）*:

- **処理速度**: 典型的ペイロードでJSON-RPCメッセージあたり101.24μs（0.1ms）
- **メモリ使用量**: 処理中にメッセージあたり約13.4KB、ストリームサイズには定数O(1)
- **スループット**: 連続NDJSONストリームシナリオで30.9Kメッセージ/秒
- **単一メッセージスループット**: 個別JSON-RPC処理で9.9Kメッセージ/秒
- **構造保持**: 除去後にJSON-RPC整合性100%維持

**制限事項**:

- **JSON組み込みPII検出**: 62.5%の検出率は構造化データ内でのJSONコンテキスト分析改善の必要性を示す
- **大容量単一行JSONメッセージ**: ストリーム処理でのバッファリング効率に影響する可能性
- **複雑にネストしたJSON構造**: 再帰処理オーバーヘッドが必要
- **非標準JSON-RPC拡張**: 追加検証パターンが必要な場合がある

**将来の改善**:

- 構造化データ内でのより良いPII検出のためのJSONキーベースコンテキストヒントの強化
- 複雑にネストした構造のための最適化された再帰JSON走査
- カスタムプロトコル拡張のためのJSON-RPC検証パターン拡張

## 性能特性

- **速度**: シングルパス正規表現最適化により、典型的な文書で1ms未満の検出時間
- **メモリ**: ストリーミングアーキテクチャによりドキュメントサイズに関係ない一定メモリ使用量
- **スケーラビリティ**: Web Standards（WHATWG Streams）によりエッジデプロイメントとワーカー環境に対応

## エラー分析

### 一般的な誤検出

1. **メール風URL**: 境界検出改善により解決
2. **クレジットカード風数字**: Luhn検証とコンテキストフィルタリングで軽減
3. **JWT風Base64**: 適切な3部構造検証で削減

### 一般的な見逃し

1. **特殊メール形式**: 複雑なスクリプトの国際ドメイン
2. **非標準カード形式**: 特殊な区切り文字パターンのカード
3. **断片化トークン**: 複数行に分割されたJWTやAPIキー

### 継続的改善

- **パターン更新**: 新しいPII形式と標準に基づく定期更新
- **コンテキスト強化**: より良い精度のためのコンテキストスコアリング改善
- **ユーザーフィードバック**: 実際の使用状況フィードバックの評価への統合

## 検証と再現性

### 結果の再現

1. **環境**: norenパッケージがインストールされたNode.js 20.10+
2. **実行**: `node examples/evaluate-detection.mjs`を実行
3. **出力**: 詳細レポートが`docs/evaluation/`に生成

```bash
# 依存関係のインストール
pnpm install

# 評価実行
node examples/evaluate-detection.mjs

# 結果確認
cat docs/evaluation/v0.6.2-report.md
```

### データセットアクセス

- **場所**: `packages/noren-devtools/datasets/ground-truth/`
- **形式**: 標準化されたアノテーションスキーマのJSON
- **検証**: 一貫性と精度のための各データセットエントリの検証

### 監査証跡

- **バージョン**: @himorishige/noren-core v0.6.2
- **評価日**: 各実行時に自動生成
- **手法**: ソースコード付きの文書化された評価フレームワーク
- **再現性**: 固定ランダムシードと決定的処理

## セキュリティとプライバシー

### データ保護

- **実PII不使用**: すべてのテストデータは合成でプライバシーバイデザイン原則に従う
- **コンプライアンス**: 評価手法はGDPR、CCPA等のプライバシー規制をサポート
- **透明性**: オープンな評価プロセスにより外部監査と検証が可能

### 責任ある開示

- **制限事項**: 現在の制限とエッジケースの明確な文書化
- **更新**: 新興脅威に基づく検出パターンの定期更新
- **コミュニティ**: オープンソース開発によりコミュニティ貢献とレビューが可能

## 将来の改善

### 計画された機能強化

1. **カバレッジ拡張**: 追加PIIタイプ（電話番号、住所、ID）
2. **多言語サポート**: 非英語言語の強化パターン
3. **機械学習統合**: 複雑なパターンのためのハイブリッドルール-ML手法
4. **動的更新**: 新興PIIフォーマットのランタイムパターン更新

### 研究領域

- **コンテキスト理解**: 誤検出削減のための改良されたコンテキスト分析
- **セマンティック検出**: 暗黙的PII参照のための自然言語理解
- **プライバシー保護評価**: 機密データを露出させない評価技術

## 結論

norenは以下の点でcore PIIとセキュリティトークン検出において強力な性能を実証しています：

- **高精度**: 全体F1スコア96.4%、適合率97.7%を全エンティティタイプで実現
- **包括的カバレッジ**: 120テストケースにわたる多様なパターンとエッジケースの効果的な処理
- **プロダクション対応**: 実際のデプロイメントに適した性能特性
- **透明な検証**: 検証と改善を可能にするオープンな評価手法

体系的な評価アプローチにより、norenの検出能力に対する信頼性を提供し、継続的な機能強化のための領域を特定しています。定期的な更新とコミュニティフィードバックにより、新興PIIパターンへの継続的改善と適応を確保しています。

---

**最終更新**: 評価実行時に自動生成  
**バージョン**: @himorishige/noren-core v0.6.2  
**評価フレームワーク**: @himorishige/noren-devtools  

技術詳細とソースコードについては：[GitHubリポジトリ](https://github.com/himorishige/noren)