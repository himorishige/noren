name: Canary Release

on:
  push:
    branches:
      - develop
  # PRマージ時のみcanaryリリースしたい場合は下記に変更
  # pull_request:
  #   types: [closed]
  #   branches:
  #     - develop

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  canary:
    name: Canary Release
    runs-on: ubuntu-latest
    # PRマージ時のみの場合は下記のif文を有効化
    # if: github.event.pull_request.merged == true
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeCheck
        run: pnpm typecheck

      - name: Run Tests
        run: pnpm test

      - name: Run Linting
        run: pnpm check

      - name: Build packages
        run: pnpm build

      - name: Generate canary version
        id: canary-version
        run: |
          # タイムスタンプベースのcanaryバージョン生成
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          # 短縮コミットハッシュも含める
          SHORT_SHA=${GITHUB_SHA:0:7}
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Create and publish canary release
        id: changesets
        uses: changesets/action@v1
        with:
          # snapshotモードでcanaryリリース実行
          publish: pnpm changeset:publish --tag canary
          version: pnpm changeset:version --snapshot canary-${{ steps.canary-version.outputs.timestamp }}
          commit: "chore: canary release canary-${{ steps.canary-version.outputs.timestamp }}"
          title: "chore: canary release canary-${{ steps.canary-version.outputs.timestamp }}"
          createGithubReleases: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Clean old canary releases
        if: steps.changesets.outputs.published == 'true'
        run: |
          echo "Canary release published! Consider implementing cleanup of old canary versions."
          echo "Published packages:"
          echo "${{ steps.changesets.outputs.publishedPackages }}"

      - name: Notify canary release
        if: steps.changesets.outputs.published == 'true'
        run: |
          echo "🚀 Canary release published: canary-${{ steps.canary-version.outputs.timestamp }}"
          echo "Install with: npm install @himorishige/noren-core@canary"